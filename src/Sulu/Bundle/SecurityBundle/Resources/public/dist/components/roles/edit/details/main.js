define(["config","services/sulusecurity/role-manager"],function(a,b){"use strict";var c,d=a.get("sulusecurity.permissions"),e="#matrix-container",f="#matrix",g="#role-form",h=!0;return{name:"Sulu Security Role Form",layout:{},templates:["/admin/security/template/role/form"],initialize:function(){this.saved=!0,this.data=this.options.data(),c=this.data.permissions,this.sandbox.on("husky.select.system.initialize",function(){this.initializeMatrices(this.sandbox.dom.data("#system","selection-values")[0]),this.initializeValidation(),this.bindDOMEvents(),this.bindCustomEvents(),this.listenForChange()}.bind(this)),this.render()},bindDOMEvents:function(){this.sandbox.dom.on("#change-all","click",this.selectAllOrNone.bind(this))},bindCustomEvents:function(){this.sandbox.on("husky.matrix.changed",function(a){this.changePermission(a)}.bind(this)),this.sandbox.on("sulu.tab.save",this.save.bind(this)),this.sandbox.on("husky.select.system.selected.item",function(){this.initializeMatrices(this.sandbox.dom.data("#system","selection-values")[0])}.bind(this))},initializeValidation:function(){this.sandbox.form.create(g)},initializeMatrices:function(a){var b=this.sandbox.dom.createElement('<div id="matrix" class="loading"/>');this.sandbox.stop(f),this.sandbox.dom.append(e,b),this.sandbox.util.ajax({url:"/admin/contexts?system="+a}).done(function(a){for(var c in a)a.hasOwnProperty(c)&&this.initializeMatrix(c,a[c]);this.sandbox.dom.removeClass(b,"loading")}.bind(this))},initializeMatrix:function(a,b){var e,g,h=[],i=[],j=!1,k=[];for(var l in b)j=!1,b.hasOwnProperty(l)&&(g=[],d.forEach(function(a){-1!==b[l].indexOf(a.value)&&g.push(a)}),k.push(g),h.push(l.split(".").splice(2).join(".")),c.forEach(function(a){a.context===l&&(j=!0,e=i.push([])-1,b[l].forEach(function(b){i[e].push(a.permissions[b])}))}),j||i.push([]));this.sandbox.start([{name:"matrix@husky",options:{el:f,captions:{general:a,type:this.sandbox.translate("security.roles.section"),horizontal:this.sandbox.translate("security.roles.permissions"),all:this.sandbox.translate("security.roles.all"),none:this.sandbox.translate("security.roles.none"),vertical:h},values:{vertical:Object.keys(b),horizontal:k},data:i}}])},changePermission:function(a){var b=$("#matrix").find(".is-active");"string"==typeof a.value?this.setPermission(a.section,a.value,a.activated):this.sandbox.dom.each(a.value,function(b,c){this.setPermission(a.section,c.value,a.activated)}.bind(this)),a.activated||this.sandbox.dom.attr("#god",{checked:!1}),this.changeSelectAllNoneButton(b.length)},setPermission:function(a,b,d){var e=this.getContextKey(a);c[e]?c[e].permissions[b]=d:(c[e]={},c[e].context=a,c[e].permissions={},c[e].permissions[b]=d)},getContextKey:function(a){var b=c.length;return c.forEach(function(c,d){c.context===a&&(b=d)}),b},save:function(){if(this.sandbox.form.validate(g)){this.sandbox.emit("sulu.tab.saving");var a={id:this.sandbox.dom.val("#id"),name:this.sandbox.dom.val("#name"),system:this.sandbox.dom.data("#system","selection-values")[0],permissions:c};this.data=this.sandbox.util.extend(!0,{},this.data,a),b.save(this.data).then(function(a){this.sandbox.emit("sulu.tab.saved",a,!0)}.bind(this)).fail(function(a){this.sandbox.emit("sulu.tab.save-error",a.responseJSON.code)}.bind(this))}},render:function(){this.$el.html(this.renderTemplate("/admin/security/template/role/form",{data:this.data})),this.sandbox.start(this.$el),this.data.permissions&&this.changeSelectAllNoneButton(this.data.permissions.length)},selectAllOrNone:function(){h?(this.sandbox.emit("husky.matrix.unset-all"),h=!1,$("#change-all").html(this.sandbox.translate("security.roles.all"))):h||(this.sandbox.emit("husky.matrix.set-all"),h=!0,$("#change-all").html(this.sandbox.translate("security.roles.none")))},changeSelectAllNoneButton:function(a){a?($("#change-all").html(this.sandbox.translate("security.roles.none")),h=!0):a||($("#change-all").html(this.sandbox.translate("security.roles.all")),h=!1)},listenForChange:function(){this.sandbox.dom.on("#role-form","change",function(){this.sandbox.emit("sulu.tab.dirty")}.bind(this),"select, input"),this.sandbox.dom.on("#role-form","keyup",function(){this.sandbox.emit("sulu.tab.dirty")}.bind(this),"input"),this.sandbox.on("husky.matrix.changed",function(){this.sandbox.emit("sulu.tab.dirty")}.bind(this)),this.sandbox.on("husky.select.system.selected.item",function(a){this.sandbox.emit("sulu.tab.dirty")}.bind(this)),this.sandbox.on("husky.select.security-type.selected.item",function(a){this.sandbox.emit("sulu.tab.dirty")}.bind(this))}}});